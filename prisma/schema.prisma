generator client {
  provider      = "prisma-client"
  output        = "../src/generated/prisma"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
}

enum EmployeeType {
  FULL_TIME
  PART_TIME
  INTERN
  CONSULTANT
}

enum NotificationRecordType {
  EMAIL
  SMS
}

model Organization {
  id          String   @id @default(cuid())
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // @deprecated - Billing user is now determined from Clerk subscription payer information. This field is kept for backward compatibility but should not be used. Use Clerk organization subscription to get payer information.
  billingUserId        String?
  // @deprecated - Subscription plan ID is now stored in Clerk as the source of truth. This field is kept for backward compatibility but should not be used. Use Clerk organization subscription API instead.
  subscriptionPlanId   String?
  // @deprecated - Subscription plan name is now stored in Clerk as the source of truth. This field is kept for backward compatibility but should not be used. Use Clerk organization subscription API instead.
  subscriptionPlanName String?
  // @deprecated - Subscription status is now stored in Clerk as the source of truth. This field is kept for backward compatibility but should not be used. Use Clerk organization subscription API instead.
  subscriptionStatus   String?
  clerkOrganizationId  String  @unique // Clerk organization ID (required) - name, slug, and subscription info are stored in Clerk

  // Initiative size definitions - JSON object with keys: xs, s, m, l, xl and string values describing what each size means
  initiativeSizeDefinitions Json?

  // Relationships
  billingUser            User?                    @relation("BillingUser", fields: [billingUserId], references: [id])
  members                OrganizationMember[]
  teams                  Team[]
  people                 Person[]
  initiatives            Initiative[]
  invitations            OrganizationInvitation[]
  meetings               Meeting[]
  meetingInstances       MeetingInstance[]
  entityLinks            EntityLink[]
  jobRoles               JobRole[]
  levels                 JobLevel[]
  domains                JobDomain[]
  notifications          Notification[]
  reportInstances        ReportInstance[]
  cronJobExecutions      CronJobExecution[]
  notes                  Note[]
  fileAttachments        FileAttachment[]
  githubOrgs             OrganizationGithubOrg[]
  integrations           Integration[]            @relation("OrganizationIntegrations")
  entityIntegrationLinks EntityIntegrationLink[]
  toleranceRules         OrganizationToleranceRule[]
  exceptions             Exception[]
  noteImages             NoteImage[]
  oauthClients           OAuthClientMetadata[]   @relation("OAuthClients")
  onboardingTemplates    OnboardingTemplate[]
  onboardingInstances    OnboardingInstance[]

  @@index([billingUserId])
  @@index([subscriptionPlanId])
  @@index([subscriptionStatus])
  @@index([clerkOrganizationId])
}

model User {
  id                      String                   @id @default(cuid())
  email                   String                   @unique
  name                    String
  passwordHash            String? // Optional for Clerk-managed users
  clerkUserId             String?                  @unique // Clerk user ID
  personId                String?                  @unique
  person                  Person?                  @relation(fields: [personId], references: [id])
  sentInvitations         OrganizationInvitation[]
  organizationMemberships OrganizationMember[]
  billingOrganizations    Organization[]           @relation("BillingUser")
  jiraCredentials         UserJiraCredentials?
  githubCredentials       UserGithubCredentials?
  feedbackCampaigns       FeedbackCampaign[]
  createdTasks            Task[]
  createdMeetings         Meeting[]
  createdEntityLinks      EntityLink[]
  notifications           Notification[]
  notificationResponses   NotificationResponse[]
  ownedReports            Report[]                 @relation("ReportOwner")
  reportRuns              ReportInstance[]
  notes                   Note[]                  @relation("NoteCreator")
  sharedNotes             NoteShare[]              @relation("SharedNotes")
  fileAttachments         FileAttachment[]
  integrations            Integration[]            @relation("UserIntegrations")
  noteImages              NoteImage[]              @relation("NoteImageUploader")
  createdOAuthClients     OAuthClientMetadata[]    @relation("OAuthClientCreator")
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt

  @@index([personId])
  @@index([clerkUserId])
}

model OrganizationMember {
  id             String       @id @default(cuid())
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  role           String       @default("USER") // @deprecated - Role is now stored in Clerk as the source of truth. This field is kept for backward compatibility but should not be used. Use Clerk organization membership role instead.
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@unique([userId, organizationId])
  @@index([userId])
  @@index([organizationId])
  @@index([role])
}

model Team {
  id             String       @id @default(cuid())
  name           String
  description    String?
  avatar         String? // Avatar URL (external URL or R2 storage URL)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  parentId       String?
  parent         Team?        @relation("TeamHierarchy", fields: [parentId], references: [id])
  children       Team[]       @relation("TeamHierarchy")
  people         Person[]
  initiatives    Initiative[]
  meetings       Meeting[]
  onboardingTemplates OnboardingTemplate[]
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([organizationId])
  @@index([parentId])
}

model Person {
  id                 String               @id @default(cuid())
  email              String?
  name               String
  role               String?
  status             String               @default("active")
  birthday           DateTime?
  avatar             String? // Avatar URL (external URL or R2 storage URL)
  employeeType       EmployeeType? // Type of employee (Full Time, Part Time, Intern, Consultant)
  organizationId     String
  organization       Organization         @relation(fields: [organizationId], references: [id])
  teamId             String?
  team               Team?                @relation(fields: [teamId], references: [id])
  managerId          String?
  manager            Person?              @relation("MgrReports", fields: [managerId], references: [id])
  reports            Person[]             @relation("MgrReports")
  jobRoleId          String?
  jobRole            JobRole?             @relation(fields: [jobRoleId], references: [id])
  startedAt          DateTime?
  tasks              Task[]
  oneOnOnes          OneOnOne[]           @relation("OOOReport")
  oneOnOnesAsManager OneOnOne[]           @relation("OOOManager")
  idps               IDP[]
  feedback           Feedback[]           @relation("About")
  feedbackFrom       Feedback[]           @relation("From")
  initiativeOwners   InitiativeOwner[]
  checkIns           CheckIn[]
  events             Event[]
  user               User?
  jiraAccount        PersonJiraAccount?
  githubAccount      PersonGithubAccount?
  feedbackCampaigns  FeedbackCampaign[]   @relation("CampaignTarget")
  ownedMeetings      Meeting[]            @relation("MeetingOwner")

  meetingParticipants         MeetingParticipant[]         @relation("MeetingParticipant")
  meetingInstanceParticipants MeetingInstanceParticipant[] @relation("MeetingInstanceParticipant")
  createdAt                   DateTime                     @default(now())
  updatedAt                   DateTime                     @updatedAt
  synopses                    PersonSynopsis[]

  // Onboarding relationships
  onboardingInstances          OnboardingInstance[]       // Onboardings this person is going through
  managedOnboardings           OnboardingInstance[]       @relation("OnboardingManager")
  mentoredOnboardings          OnboardingInstance[]       @relation("OnboardingMentor")
  completedOnboardingItems     OnboardingItemProgress[]   // Items this person completed (for others)

  @@index([organizationId])
  @@index([jobRoleId])
}

model Initiative {
  id             String            @id @default(cuid())
  teamId         String?
  team           Team?             @relation(fields: [teamId], references: [id])
  organizationId String
  organization   Organization      @relation(fields: [organizationId], references: [id])
  title          String
  summary        String?
  outcome        String?
  startDate      DateTime?
  targetDate     DateTime?
  status         String            @default("planned") // planned|in_progress|paused|done|canceled
  rag            String            @default("green") // green|amber|red
  confidence     Int               @default(80)
  priority       Int               @default(2)
  size           String?           // xs|s|m|l|xl - initiative size/effort estimation
  slot           Int?              // slot position for slots view (null = unassigned)
  objectives     Objective[]
  owners         InitiativeOwner[]
  checkIns       CheckIn[]
  metrics        Metric[]
  tasks          Task[]
  meetings       Meeting[]
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  @@unique([organizationId, slot])
  @@index([organizationId])
}

model InitiativeOwner {
  initiativeId String
  personId     String
  role         String @default("owner") // owner|sponsor|collaborator

  initiative Initiative @relation(fields: [initiativeId], references: [id])
  person     Person     @relation(fields: [personId], references: [id])

  @@id([initiativeId, personId])
}

model Objective {
  id           String     @id @default(cuid())
  initiativeId String
  initiative   Initiative @relation(fields: [initiativeId], references: [id])
  title        String
  keyResult    String?
  sortIndex    Int        @default(0)
  tasks        Task[]
}

model Task {
  id           String      @id @default(cuid())
  objectiveId  String?
  objective    Objective?  @relation(fields: [objectiveId], references: [id])
  initiativeId String?
  initiative   Initiative? @relation(fields: [initiativeId], references: [id])
  title        String
  description  String?
  assigneeId   String?
  assignee     Person?     @relation(fields: [assigneeId], references: [id])
  createdById  String
  createdBy    User        @relation(fields: [createdById], references: [id])
  status       String      @default("todo") // todo|doing|blocked|done|dropped
  priority     Int         @default(2)
  estimate     Int?
  dueDate      DateTime?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  completedAt  DateTime?
}

model CheckIn {
  id           String     @id @default(cuid())
  initiativeId String
  initiative   Initiative @relation(fields: [initiativeId], references: [id])
  weekOf       DateTime
  rag          String     @default("green")
  confidence   Int        @default(80)
  summary      String
  blockers     String?
  nextSteps    String?
  createdById  String
  createdBy    Person     @relation(fields: [createdById], references: [id])
  createdAt    DateTime   @default(now())
}

model OneOnOne {
  id          String    @id @default(cuid())
  managerId   String
  reportId    String
  scheduledAt DateTime?
  notes       String?
  // actionItems  Task[]   @relation("OneOnOneTasks")
  manager     Person    @relation("OOOManager", fields: [managerId], references: [id])
  report      Person    @relation("OOOReport", fields: [reportId], references: [id])
}

model IDP {
  id        String    @id @default(cuid())
  personId  String
  person    Person    @relation(fields: [personId], references: [id])
  period    String
  summary   String?
  goals     IDPGoal[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model IDPGoal {
  id      String    @id @default(cuid())
  idpId   String
  idp     IDP       @relation(fields: [idpId], references: [id])
  title   String
  metric  String?
  target  String?
  status  String    @default("in_progress")
  dueDate DateTime?
}

model Feedback {
  id        String   @id @default(cuid())
  aboutId   String
  about     Person   @relation("About", fields: [aboutId], references: [id])
  fromId    String
  from      Person   @relation("From", fields: [fromId], references: [id])
  kind      String   @default("note") // praise|concern|note
  isPrivate Boolean  @default(true)
  body      String
  createdAt DateTime @default(now())
}

model Metric {
  id           String     @id @default(cuid())
  initiativeId String
  initiative   Initiative @relation(fields: [initiativeId], references: [id])
  name         String
  unit         String?
  value        Float
  capturedAt   DateTime   @default(now())
}

model Tag {
  id    String   @id @default(cuid())
  name  String   @unique
  color String?
  maps  TagMap[]
}

model TagMap {
  tagId    String
  tag      Tag    @relation(fields: [tagId], references: [id])
  entity   String
  entityId String

  @@id([tagId, entity, entityId])
}

model OrganizationInvitation {
  id             String       @id @default(cuid())
  email          String
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  invitedById    String
  invitedBy      User         @relation(fields: [invitedById], references: [id])
  status         String       @default("pending") // pending|accepted|expired|revoked
  expiresAt      DateTime
  acceptedAt     DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@unique([email, organizationId])
  @@index([organizationId])
  @@index([email])
  @@index([status])
}

model Event {
  id        String   @id @default(cuid())
  actorId   String?
  actor     Person?  @relation(fields: [actorId], references: [id])
  entity    String
  entityId  String
  action    String
  metadata  String?
  createdAt DateTime @default(now())
}

model UserJiraCredentials {
  id              String   @id @default(cuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  jiraUsername    String
  encryptedApiKey String
  jiraBaseUrl     String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model PersonJiraAccount {
  id              String   @id @default(cuid())
  personId        String   @unique
  person          Person   @relation(fields: [personId], references: [id], onDelete: Cascade)
  jiraAccountId   String
  jiraEmail       String
  jiraDisplayName String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([jiraAccountId])
  @@index([jiraEmail])
}

model UserGithubCredentials {
  id             String   @id @default(cuid())
  userId         String   @unique
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  githubUsername String
  encryptedPat   String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model PersonGithubAccount {
  id                String   @id @default(cuid())
  personId          String   @unique
  person            Person   @relation(fields: [personId], references: [id], onDelete: Cascade)
  githubUsername    String
  githubDisplayName String?
  githubEmail       String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([githubUsername])
}

model FeedbackCampaign {
  id                  String               @id @default(cuid())
  name                String? // Custom name for the campaign (e.g., "Performance Review 2026")
  userId              String
  user                User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  targetPersonId      String
  targetPerson        Person               @relation("CampaignTarget", fields: [targetPersonId], references: [id], onDelete: Cascade)
  templateId          String?
  template            FeedbackTemplate?    @relation(fields: [templateId], references: [id], onDelete: SetNull)
  startDate           DateTime
  endDate             DateTime
  inviteEmails        String[] // Array of email addresses to invite
  inviteLink          String? // Unique link for invitees to access the feedback form
  status              String               @default("draft") // draft|active|completed|cancelled
  responses           FeedbackResponse[]
  notificationRecords NotificationRecord[]
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt

  @@index([userId])
  @@index([targetPersonId])
  @@index([templateId])
  @@index([status])
  @@index([startDate])
  @@index([endDate])
  @@index([inviteLink])
}

model FeedbackResponse {
  id             String           @id @default(cuid())
  campaignId     String
  campaign       FeedbackCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  responderEmail String
  responses      Json // Store the structured feedback responses as JSON
  submittedAt    DateTime         @default(now())

  @@unique([campaignId, responderEmail]) // Prevent duplicate responses from same email
  @@index([campaignId])
  @@index([responderEmail])
}

model FeedbackTemplate {
  id          String             @id @default(cuid())
  name        String
  description String?
  isDefault   Boolean            @default(false)
  questions   FeedbackQuestion[]
  campaigns   FeedbackCampaign[]
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt

  @@index([isDefault])
}

model FeedbackQuestion {
  id         String           @id @default(cuid())
  templateId String
  template   FeedbackTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  question   String
  type       String           @default("text") // text|rating|multiple_choice
  required   Boolean          @default(true)
  options    Json? // For multiple choice questions
  sortOrder  Int              @default(0)
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt

  @@index([templateId])
  @@index([sortOrder])
}

model NotificationRecord {
  id             String                 @id @default(cuid())
  type           NotificationRecordType @default(EMAIL)
  campaignId     String?
  campaign       FeedbackCampaign?      @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  recipientEmail String
  subject        String
  sentAt         DateTime               @default(now())
  metadata       Json? // Additional tracking data (e.g., email type: 'invite' | 'reminder')
  createdAt      DateTime               @default(now())
  updatedAt      DateTime               @updatedAt

  @@index([campaignId])
  @@index([recipientEmail])
  @@index([sentAt])
  @@index([type])
}

model Meeting {
  id             String               @id @default(cuid())
  title          String
  description    String?
  scheduledAt    DateTime
  duration       Int? // Duration in minutes
  location       String? // Physical or virtual location
  notes          String? // Open area for notes
  isRecurring    Boolean              @default(false)
  recurrenceType String? // daily|weekly|monthly|bi_monthly|semi_annually
  isPrivate      Boolean              @default(true) // Private meetings are only visible to creator and participants
  organizationId String
  organization   Organization         @relation(fields: [organizationId], references: [id])
  teamId         String? // Optional team association
  team           Team?                @relation(fields: [teamId], references: [id])
  initiativeId   String? // Optional initiative association
  initiative     Initiative?          @relation(fields: [initiativeId], references: [id])
  ownerId        String? // Meeting owner (assigned to a person)
  owner          Person?              @relation("MeetingOwner", fields: [ownerId], references: [id])
  createdById    String // User who created the meeting
  createdBy      User                 @relation(fields: [createdById], references: [id])
  participants   MeetingParticipant[]
  instances      MeetingInstance[]
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt

  @@index([organizationId])
  @@index([teamId])
  @@index([initiativeId])
  @@index([ownerId])
  @@index([createdById])
  @@index([scheduledAt])
  @@index([isRecurring])
}

model MeetingParticipant {
  id        String   @id @default(cuid())
  meetingId String
  meeting   Meeting  @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  personId  String
  person    Person   @relation("MeetingParticipant", fields: [personId], references: [id])
  status    String   @default("invited") // invited|accepted|declined|tentative
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([meetingId, personId])
  @@index([meetingId])
  @@index([personId])
  @@index([status])
}

model MeetingInstance {
  id             String                       @id @default(cuid())
  meetingId      String
  meeting        Meeting                      @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  scheduledAt    DateTime // Specific date/time for this instance
  notes          String? // Notes for this specific instance
  isPrivate      Boolean                      @default(true) // Inherits privacy from parent meeting
  organizationId String
  organization   Organization                 @relation(fields: [organizationId], references: [id])
  participants   MeetingInstanceParticipant[]
  createdAt      DateTime                     @default(now())
  updatedAt      DateTime                     @updatedAt

  @@index([meetingId])
  @@index([organizationId])
  @@index([scheduledAt])
}

model MeetingInstanceParticipant {
  id                String          @id @default(cuid())
  meetingInstanceId String
  meetingInstance   MeetingInstance @relation(fields: [meetingInstanceId], references: [id], onDelete: Cascade)
  personId          String
  person            Person          @relation("MeetingInstanceParticipant", fields: [personId], references: [id])
  status            String          @default("invited") // invited|accepted|declined|tentative|attended|absent
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  @@unique([meetingInstanceId, personId])
  @@index([meetingInstanceId])
  @@index([personId])
  @@index([status])
}

model PersonSynopsis {
  id              String   @id @default(cuid())
  personId        String
  person          Person   @relation(fields: [personId], references: [id], onDelete: Cascade)
  fromDate        DateTime
  toDate          DateTime
  includeFeedback Boolean  @default(false)
  content         String
  sources         String[]
  type            String   @default("overview") // overview, jira-activity, github-activity
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([personId])
  @@index([fromDate])
  @@index([toDate])
  @@index([type])
}

model EntityLink {
  id             String       @id @default(cuid())
  url            String
  title          String?
  description    String?
  entityType     String // The type of entity (e.g., "Initiative", "Task", "Meeting", "MeetingInstance", "Team", "Person", "OneOnOne")
  entityId       String // The ID of the entity
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdById    String
  createdBy      User         @relation(fields: [createdById], references: [id], onDelete: Cascade)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([entityType, entityId])
  @@index([organizationId])
  @@index([createdById])
}

model JobRole {
  id             String       @id @default(cuid())
  title          String
  description    String? // Markdown-enabled job description
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  levelId        String
  level          JobLevel     @relation("JobRoleLevel", fields: [levelId], references: [id], onDelete: Restrict)
  domainId       String
  domain         JobDomain    @relation("JobRoleDomain", fields: [domainId], references: [id], onDelete: Restrict)
  people         Person[]
  onboardingTemplates OnboardingTemplate[]
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([organizationId])
  @@index([levelId])
  @@index([domainId])
}

model JobLevel {
  id             String       @id @default(cuid())
  name           String
  order          Int          @default(0)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  jobRoles       JobRole[]    @relation("JobRoleLevel")
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@unique([name, organizationId])
  @@index([organizationId])
  @@index([order])
}

model JobDomain {
  id             String       @id @default(cuid())
  name           String
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  jobRoles       JobRole[]    @relation("JobRoleDomain")
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@unique([name, organizationId])
  @@index([organizationId])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expires   DateTime
  createdAt DateTime @default(now())

  @@index([email])
  @@index([token])
}

model Notification {
  id             String        @id @default(cuid())
  title          String
  message        String
  type           String        @default("info") // info|warning|success|error
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])
  userId         String? // If null, it's an organization-wide notification
  user           User?         @relation(fields: [userId], references: [id])
  metadata       Json? // Additional data for deduplication and job tracking
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  // Relationships
  responses NotificationResponse[]
  exception Exception?

  @@index([organizationId])
  @@index([userId])
  @@index([createdAt])
}

model NotificationResponse {
  id             String       @id @default(cuid())
  notificationId String
  notification   Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  status         String       @default("unread") // unread|read|dismissed|acknowledged|ignored|resolved
  readAt         DateTime?
  dismissedAt    DateTime?
  acknowledgedAt DateTime?
  ignoredAt      DateTime?
  resolvedAt     DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@unique([notificationId, userId])
  @@index([notificationId])
  @@index([userId])
  @@index([status])
}

model CronJobExecution {
  id                   String        @id @default(cuid())
  jobId                String
  jobName              String
  organizationId       String?
  organization         Organization? @relation(fields: [organizationId], references: [id])
  status               String        @default("running") // running|completed|failed
  startedAt            DateTime      @default(now())
  completedAt          DateTime?
  notificationsCreated Int           @default(0)
  error                String?
  metadata             Json?
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt

  @@index([jobId])
  @@index([organizationId])
  @@index([startedAt])
  @@index([status])
}

/// Reports define executable, extensible data aggregations.
model Report {
  id          String           @id @default(cuid())
  codeId      String           @unique // Stable code identifier that maps to implementation/registry
  name        String
  description String?
  ownerId     String?
  owner       User?            @relation("ReportOwner", fields: [ownerId], references: [id], onDelete: SetNull)
  inputSchema Json? // Optional JSON schema/Zod-like descriptor for dynamic forms
  enabled     Boolean          @default(true)
  renderers   String[] // Supported renderer identifiers (e.g., ["markdown"]) 
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  instances   ReportInstance[]

  @@index([ownerId])
}

/// A single execution of a report with captured inputs and outputs
model ReportInstance {
  id             String       @id @default(cuid())
  reportId       String
  report         Report       @relation(fields: [reportId], references: [id], onDelete: Cascade)
  userId         String // The user who executed the report
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organizationId String // Redundant but used for strong org isolation filters
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  renderer       String // Renderer used for this instance (e.g., "markdown")
  input          Json // Input values used to execute the report
  output         Json // Raw JSON output of the report execution
  status         String       @default("completed") // queued|running|failed|completed
  errorMessage   String?
  startedAt      DateTime     @default(now())
  completedAt    DateTime?

  @@index([reportId])
  @@index([userId])
  @@index([organizationId])
  @@index([status])
  @@index([startedAt])
  @@index([completedAt])
}

model Note {
  id                 String           @id @default(cuid())
  title              String? // Title for standalone notes (optional)
  entityType         String? // The type of entity (e.g., "Initiative", "Task", "Meeting", "Person") - optional for standalone notes
  entityId           String? // The ID of the entity - optional for standalone notes
  organizationId     String
  organization       Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  content            String
  createdById        String
  createdBy          User             @relation("NoteCreator", fields: [createdById], references: [id], onDelete: Cascade)
  sharedWithEveryone Boolean          @default(false) // If true, note is shared with all organization members
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  attachments        FileAttachment[]
  sharedWith         NoteShare[]

  @@index([entityType, entityId])
  @@index([organizationId])
  @@index([createdById])
  @@index([createdAt])
  @@index([title])
  @@index([sharedWithEveryone])
}

model NoteShare {
  id        String   @id @default(cuid())
  noteId   String
  note     Note     @relation(fields: [noteId], references: [id], onDelete: Cascade)
  userId   String
  user     User     @relation("SharedNotes", fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([noteId, userId])
  @@index([noteId])
  @@index([userId])
}

// Inline images embedded in note content - served through authenticated proxy
model NoteImage {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  uploadedById   String
  uploadedBy     User         @relation("NoteImageUploader", fields: [uploadedById], references: [id], onDelete: Cascade)
  fileName       String       // Generated unique filename
  originalName   String       // Original filename from upload
  fileSize       Int
  mimeType       String
  r2Key          String       // Cloudflare R2 object key (private)
  createdAt      DateTime     @default(now())

  @@index([organizationId])
  @@index([uploadedById])
  @@index([createdAt])
}

model FileAttachment {
  id             String       @id @default(cuid())
  noteId         String?
  note           Note?        @relation(fields: [noteId], references: [id], onDelete: Cascade)
  entityType     String // The type of entity (e.g., "Initiative", "Task", "Meeting", "Person")
  entityId       String // The ID of the entity
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  fileName       String
  originalName   String
  fileSize       Int
  mimeType       String
  r2Key          String // Cloudflare R2 object key
  r2Url          String // Public URL for the file
  uploadedById   String
  uploadedBy     User         @relation(fields: [uploadedById], references: [id], onDelete: Cascade)
  createdAt      DateTime     @default(now())

  @@index([noteId])
  @@index([entityType, entityId])
  @@index([organizationId])
  @@index([uploadedById])
  @@index([createdAt])
}

model OrganizationGithubOrg {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  githubOrgName  String // GitHub organization name (e.g., "acme-corp")
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@unique([organizationId, githubOrgName])
  @@index([organizationId])
  @@index([githubOrgName])
}

model Integration {
  id                   String                  @id @default(cuid())
  organizationId       String?
  organization         Organization?           @relation("OrganizationIntegrations", fields: [organizationId], references: [id], onDelete: Cascade)
  userId               String?
  user                 User?                   @relation("UserIntegrations", fields: [userId], references: [id], onDelete: Cascade)
  integrationType      String // e.g., "google_calendar", "microsoft_outlook", "jira", "github"
  name                 String
  scope                String                  @default("organization") // "organization" | "user"
  isEnabled            Boolean                 @default(true)
  encryptedCredentials Json // Encrypted credentials stored as JSON
  metadata             Json? // Additional configuration metadata
  entityLinks          EntityIntegrationLink[]
  createdAt            DateTime                @default(now())
  updatedAt            DateTime                @updatedAt

  @@index([organizationId, integrationType])
  @@index([userId, integrationType])
  @@index([organizationId])
  @@index([userId])
  @@index([scope])
}

model EntityIntegrationLink {
  id                String       @id @default(cuid())
  organizationId    String
  organization      Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  entityType        String // The type of entity (e.g., "Meeting", "MeetingInstance", "Person")
  entityId          String // The ID of the entity
  integrationId     String
  integration       Integration  @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  externalEntityId  String // External system entity ID (e.g., calendar event ID, Jira account ID, GitHub username)
  externalEntityUrl String? // URL to the external entity
  metadata          Json? // Additional metadata about the link
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  @@index([entityType, entityId])
  @@index([integrationId])
  @@index([organizationId])
  @@index([externalEntityId])
}

model OrganizationToleranceRule {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  ruleType       String       // one_on_one_frequency|initiative_checkin|feedback_360|manager_span
  name           String       // Human-readable name
  description    String?      // Optional description
  isEnabled      Boolean      @default(true)
  config         Json         // Rule-specific configuration (thresholds, time periods, etc.)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  
  exceptions     Exception[]
  
  @@index([organizationId])
  @@index([ruleType])
  @@index([isEnabled])
}

model Exception {
  id             String                  @id @default(cuid())
  ruleId         String
  rule           OrganizationToleranceRule @relation(fields: [ruleId], references: [id], onDelete: Cascade)
  organizationId String
  organization   Organization            @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  severity       String                  @default("warning") // warning|urgent
  entityType     String                  // Person|Initiative|OneOnOne|FeedbackCampaign
  entityId       String                  // ID of the entity that triggered the exception
  message        String                  // Human-readable message
  metadata       Json?                   // Additional context data
  notificationId String?                 @unique
  notification   Notification?           @relation(fields: [notificationId], references: [id], onDelete: SetNull)
  status         String                  @default("active") // active|acknowledged|ignored|resolved
  acknowledgedAt DateTime?
  ignoredAt      DateTime?
  resolvedAt     DateTime?
  acknowledgedBy String?
  ignoredBy      String?
  resolvedBy     String?
  createdAt      DateTime                @default(now())
  updatedAt      DateTime                @updatedAt
  
  @@index([ruleId])
  @@index([organizationId])
  @@index([entityType, entityId])
  @@index([status])
  @@index([severity])
  @@index([notificationId])
}

// Optional: OAuth Client Metadata
// This model stores metadata about OAuth clients created in Clerk Dashboard
// The actual OAuth clients are managed in Clerk, but we store metadata here
// for UI display and organization tracking
model OAuthClientMetadata {
  id              String       @id @default(cuid())
  clerkClientId  String       @unique // Clerk OAuth application client ID
  name            String       // Display name
  description     String?      // Optional description
  organizationId  String       // Organization this client belongs to
  organization    Organization @relation("OAuthClients", fields: [organizationId], references: [id], onDelete: Cascade)
  createdById     String       // User who created this client
  createdBy       User         @relation("OAuthClientCreator", fields: [createdById], references: [id])
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@index([organizationId])
  @@index([createdById])
  @@index([clerkClientId])
}

// ============================================================================
// ONBOARDING SYSTEM
// Template-to-instance pattern for structured employee onboarding
// ============================================================================

enum OnboardingItemType {
  TASK        // Something to do
  READING     // Documentation to read
  MEETING     // Conversation to have
  CHECKPOINT  // Verification point (manager confirms)
  EXPECTATION // Context to understand
}

enum OnboardingStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum OnboardingItemStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  SKIPPED
  BLOCKED
}

// Reusable onboarding template definitions
model OnboardingTemplate {
  id             String               @id @default(cuid())
  name           String
  description    String?
  organizationId String
  organization   Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  teamId         String?              // Optional: team-specific template
  team           Team?                @relation(fields: [teamId], references: [id])
  jobRoleId      String?              // Optional: role-specific template
  jobRole        JobRole?             @relation(fields: [jobRoleId], references: [id])
  isDefault      Boolean              @default(false)
  isActive       Boolean              @default(true)
  phases         OnboardingPhase[]
  instances      OnboardingInstance[]
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt

  @@index([organizationId])
  @@index([teamId])
  @@index([jobRoleId])
  @@index([isDefault])
  @@index([isActive])
}

// Ordered groupings within a template (e.g., "Day 1", "Week 1", "First 30 Days")
model OnboardingPhase {
  id          String             @id @default(cuid())
  templateId  String
  template    OnboardingTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  name        String             // e.g., "Day 1", "Week 1", "First 30 Days"
  description String?
  sortOrder   Int                @default(0)
  items       OnboardingItem[]
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt

  @@index([templateId])
  @@index([sortOrder])
}

// Atomic steps within phases (tasks, readings, meetings, checkpoints, expectations)
model OnboardingItem {
  id          String             @id @default(cuid())
  phaseId     String
  phase       OnboardingPhase    @relation(fields: [phaseId], references: [id], onDelete: Cascade)
  title       String
  description String?
  type        OnboardingItemType @default(TASK)
  sortOrder   Int                @default(0)
  isRequired  Boolean            @default(true)

  // Optional references to existing entities (for context or materialization)
  linkedTaskId       String? // Reference to Task template
  linkedMeetingId    String? // Reference to Meeting template
  linkedInitiativeId String? // Reference to Initiative (for context)
  linkedUrl          String? // External resource URL

  // Ownership hints for checkpoints
  ownerType String? // "onboardee" | "manager" | "mentor"

  progress  OnboardingItemProgress[]
  createdAt DateTime               @default(now())
  updatedAt DateTime               @updatedAt

  @@index([phaseId])
  @@index([sortOrder])
  @@index([type])
}

// A live onboarding assigned to a specific person
model OnboardingInstance {
  id             String                   @id @default(cuid())
  templateId     String
  template       OnboardingTemplate       @relation(fields: [templateId], references: [id])
  personId       String
  person         Person                   @relation(fields: [personId], references: [id], onDelete: Cascade)
  organizationId String
  organization   Organization             @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  status      OnboardingStatus @default(NOT_STARTED)
  startedAt   DateTime?
  completedAt DateTime?

  // Optional role assignments
  managerId String? // Manager overseeing onboarding
  manager   Person? @relation("OnboardingManager", fields: [managerId], references: [id])
  mentorId  String? // Optional mentor/buddy
  mentor    Person? @relation("OnboardingMentor", fields: [mentorId], references: [id])

  itemProgress OnboardingItemProgress[]
  createdAt    DateTime                 @default(now())
  updatedAt    DateTime                 @updatedAt

  @@unique([personId, templateId]) // One instance per template per person
  @@index([organizationId])
  @@index([personId])
  @@index([templateId])
  @@index([status])
  @@index([managerId])
  @@index([mentorId])
}

// Tracks completion of individual items within an onboarding instance
model OnboardingItemProgress {
  id         String             @id @default(cuid())
  instanceId String
  instance   OnboardingInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  itemId     String
  item       OnboardingItem     @relation(fields: [itemId], references: [id], onDelete: Cascade)

  status        OnboardingItemStatus @default(PENDING)
  completedAt   DateTime?
  completedById String?              // Who marked it complete
  completedBy   Person?              @relation(fields: [completedById], references: [id])
  notes         String?              // Optional notes on completion

  // Materialized entity references (created from item templates)
  materializedTaskId    String? // Actual Task created for this item
  materializedMeetingId String? // Actual Meeting scheduled

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([instanceId, itemId])
  @@index([instanceId])
  @@index([itemId])
  @@index([status])
  @@index([completedById])
}
