name: Playwright Tests on Vercel Preview

# This workflow runs Playwright tests against Vercel preview deployments
# when a PR is opened, updated, or reopened.
#
# Required GitHub Secrets:
#   - VERCEL_TOKEN: Vercel API token (get from https://vercel.com/account/tokens)
#   - CLERK_SECRET_KEY: Clerk secret key for test user creation
#   - CLERK_API_URL: (Optional) Clerk API URL, defaults to https://api.clerk.com/v1
#   - TEST_DATABASE_URL: (Optional) Database URL for test database if needed

on:
    pull_request:
        types: [opened, synchronize, reopened]

jobs:
    wait-for-vercel:
        name: Wait for Vercel Deployment
        runs-on: ubuntu-latest
        outputs:
            preview-url: ${{ steps.get-deployment.outputs.url }}
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: latest

            - name: Wait for Vercel deployment and get URL
              id: get-deployment
              env:
                  VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  GITHUB_REPOSITORY: ${{ github.repository }}
                  GITHUB_SHA: ${{ github.event.pull_request.head.sha }}
              run: |
                  bun scripts/wait-for-vercel-deployment.ts ${{ github.event.pull_request.number }}
                  # Script already writes to GITHUB_OUTPUT, no need to capture stdout

    playwright-tests:
        name: Run Playwright Tests
        runs-on: ubuntu-latest
        needs: wait-for-vercel
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: latest

            - name: Install dependencies
              run: bun install

            - name: Install Playwright browsers
              run: bunx playwright install --with-deps

            - name: Run Playwright tests
              env:
                  PLAYWRIGHT_TEST_BASE_URL: ${{ needs.wait-for-vercel.outputs.preview-url }}
                  CLERK_SECRET_KEY: ${{ secrets.CLERK_SECRET_KEY }}
                  CLERK_API_URL: ${{ secrets.CLERK_API_URL || 'https://api.clerk.com/v1' }}
                  DATABASE_URL: ${{ secrets.TEST_DATABASE_URL }}
              run: bun run test
              continue-on-error: false

            - name: Upload test results
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: playwright-report
                  path: playwright-report/
                  retention-days: 30

            - name: Upload test results (HTML)
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: playwright-html-report
                  path: playwright-report/
                  retention-days: 30
